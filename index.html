<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gerenciador ‚Ä¢ Login</title>
<style>
:root{
  --bg:#0b1320; --card:#121b2e; --muted:#7b8aa1; --text:#eaf1ff;
  --primary:#4c8dff; --danger:#ff6b6b; --ok:#19c37d; --shadow:0 18px 40px rgba(0,0,0,.35);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,#0b1320 0%, #0d1528 100%); color:var(--text);
  display:flex; align-items:center; justify-content:center; padding:24px;
}
.wrap{width:100%; max-width:620px}
.row-top{display:flex; gap:10px; justify-content:flex-end; margin-bottom:14px}
.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:#1a2340;color:#dfe8ff;cursor:pointer;box-shadow:var(--shadow);display:inline-flex;align-items:center;gap:8px;font-weight:600}
.btn:hover{filter:brightness(1.06)} .btn-primary{background:var(--primary)}
.card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:26px;box-shadow:var(--shadow)}
h1{margin:0 0 10px; font-size:28px; display:flex; gap:10px; align-items:center}
.muted{color:var(--muted); font-size:14px}
.fld{display:flex; flex-direction:column; gap:6px; margin-top:14px}
.fld input{
  background:#0f1729; color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px 14px; font-size:16px; outline:none
}
.row{display:flex; gap:10px; margin-top:16px; align-items:center; flex-wrap:wrap}
.row .btn{flex:1}
.ok{color:var(--ok)} .err{color:var(--danger)}
.ver{margin-top:8px; color:#8aa4ff; font-size:12px}
.progress{height:4px;width:100%;background:#0f1729;border-radius:999px;overflow:hidden;margin:14px 0 4px}
.bar{height:100%;width:0;background:linear-gradient(90deg,#63a4ff,#4c8dff);transition:width .2s}
.inline{display:flex; align-items:center; gap:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="row-top">
    <button id="btnTheme" class="btn" title="Tema">üåô/üåû</button>
    <button id="btnReload" class="btn" title="For√ßar atualiza√ß√£o">‚ü≥ Atualizar</button>
  </div>

  <div class="card">
    <h1>üõ†Ô∏è Gerenciador</h1>
    <div id="conn" class="muted">‚Ä¶</div>

    <div class="fld">
      <label>Usu√°rio</label>
      <input id="user" placeholder="admin" autocomplete="username"/>
    </div>

    <div class="fld">
      <label class="inline">
        <span>Senha</span>
        <button id="btnShow" class="btn" style="padding:6px 10px">üëÅÔ∏è</button>
      </label>
      <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
    </div>

    <div class="row">
      <label class="inline" style="flex:1 1 100%">
        <input id="remember" type="checkbox" style="scale:1.2;margin-right:8px"> Salvar usu√°rio
      </label>
      <button id="btnPing" class="btn">üõ†Ô∏è Testar conex√£o</button>
    </div>

    <div class="row">
      <button id="btnLogin" class="btn btn-primary">Entrar</button>
    </div>

    <div class="progress" style="display:none" id="prog"><div class="bar" id="bar"></div></div>
    <div id="msg" class="muted" style="min-height:22px;margin-top:6px"></div>

    <div class="ver">v1.1.0</div>
  </div>
</div>

<script>
const API_BASE = '<?= API_BASE ?>'; // URL do pr√≥prio Apps Script
const qs = s=>document.querySelector(s);
const msg = (t, cls="muted") => { qs("#msg").className=cls; qs("#msg").textContent=t||""; };
const setConn = (ok, txt) => qs("#conn").innerHTML = ok ? `Conectado ‚Ä¢ <span class="ok">${txt}</span>` : `<span class="err">${txt}</span>`;
const prog = (v)=>{ qs("#prog").style.display="block"; qs("#bar").style.width = (v*100).toFixed(0)+"%"; if(v>=1) setTimeout(()=>qs("#prog").style.display="none",350); };

(function theme(){
  const key="mgr_theme";
  const apply=()=>{ document.documentElement.dataset.theme=localStorage.getItem(key)||"dark"; };
  apply();
  qs("#btnTheme").onclick=()=>{ localStorage.setItem(key, (localStorage.getItem(key)==="dark"?"light":"dark")); apply(); };
})();
qs("#btnReload").onclick=()=>{ location.href = location.pathname + "?v=" + Date.now(); };
qs("#btnShow").onclick=()=>{ const p=qs('#pass'); p.type = (p.type==='password'?'text':'password'); };

(function remember(){
  const u = localStorage.getItem('mgr_user') || '';
  if(u){ qs('#user').value=u; qs('#remember').checked=true; }
})();

async function apiPost(path, data){
  const r = await fetch(API_BASE + "?path=" + encodeURIComponent(path), {
    method:"POST", headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(data||{}),
  });
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}

(async()=>{
  try{
    await apiPost("/ping",{});
    setConn(true, new Date().toLocaleString());
  }catch{
    setConn(false,"Falha ao conectar");
  }
})();

qs("#btnPing").onclick = async ()=>{
  try{ prog(.2); await apiPost("/ping",{}); prog(1); msg("Conex√£o OK ‚úì","ok"); }
  catch{ prog(1); msg("Falha ao conectar","err"); }
};

qs("#btnLogin").onclick = async ()=>{
  const usuario = qs("#user").value.trim() || "admin";
  const senha   = qs("#pass").value.trim();
  if(!senha){ msg("Informe a senha","err"); return; }
  try{
    prog(.2);
    const r = await apiPost("/login",{usuario,senha});
    prog(.6);
    if(r.error){ prog(1); msg(r.error,"err"); return; }
    if(qs("#remember").checked) localStorage.setItem('mgr_user', usuario); else localStorage.removeItem('mgr_user');
    localStorage.setItem("mgr_session", JSON.stringify(r.session));
    prog(1); msg("Login OK. Indo para o painel‚Ä¶","ok");
    location.href = API_BASE + "?view=manager&v="+Date.now();
  }catch(e){
    prog(1); msg("Erro: "+e.message,"err");
  }
};
</script>
</body>
</html>
